<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troskovnik</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

    <!-- Alpine.js + Collapse plugin -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

    <!-- Custom styles -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div x-data="troskovnikApp()" x-init="init()" class="cockpit-container">

        <!-- Status Bar (Top) -->
        <div class="status-bar">
            <div class="status-bar-left">
                <div class="status-item">
                    <span class="status-label">Prihod</span>
                    <span class="status-value profit" x-text="formatCurrency(plata)"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Rashod</span>
                    <span class="status-value loss" x-text="formatCurrency(ukupniRashodi)"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Balans</span>
                    <span class="status-value" :class="ostajeZaZivot >= 0 ? 'profit' : 'loss'" x-text="formatCurrency(ostajeZaZivot)"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">%</span>
                    <span class="status-value" :class="savingsPercent >= 20 ? 'profit' : savingsPercent >= 10 ? 'warning' : 'loss'" x-text="savingsPercent.toFixed(1) + '%'"></span>
                </div>
            </div>
            <div class="status-bar-right">
                <div class="status-item">
                    <span class="status-label">Kategorija</span>
                    <span class="status-value" x-text="kategorije.length"></span>
                </div>
                <div class="status-item">
                    <span class="status-label">Stavki</span>
                    <span class="status-value" x-text="totalItems"></span>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="cockpit-header">
            <div class="cockpit-logo">
                <i class="ti ti-wallet"></i>
                <span>TROSKOVNIK</span>
            </div>

            <div class="header-controls">
                <div class="header-input-group">
                    <label>Plata</label>
                    <input
                        type="number"
                        x-model.number="plata"
                        @change="saveData()"
                        placeholder="0"
                    >
                    <span class="currency">RSD</span>
                </div>

                <button @click="openCategoryModal()" class="icon-btn" title="Kategorije">
                    <i class="ti ti-settings"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="cockpit-main">
            <!-- Left Panel - Categories Tree -->
            <div class="main-panel">
                <div class="tree-view">
                    <template x-for="kategorija in kategorije" :key="kategorija.emoji + kategorija.naziv">
                        <div class="tree-category">
                            <!-- Category Header -->
                            <div
                                class="tree-category-header"
                                :class="{ 'expanded': expandedCategories[kategorija.emoji + kategorija.naziv] }"
                                @click="toggleCategory(kategorija)"
                            >
                                <i class="ti ti-chevron-right tree-toggle" :class="{ 'expanded': expandedCategories[kategorija.emoji + kategorija.naziv] }"></i>
                                <span class="tree-category-emoji" x-text="kategorija.emoji"></span>
                                <span class="tree-category-name" x-text="kategorija.naziv"></span>
                                <span class="tree-category-total" x-text="formatCurrency(getCategoryTotal(kategorija))"></span>
                                <div class="tree-category-actions" @click.stop>
                                    <button class="tree-action-btn" @click="openAddItemModal(kategorija)" title="Dodaj stavku">
                                        <i class="ti ti-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Category Items -->
                            <div class="tree-items" x-show="expandedCategories[kategorija.emoji + kategorija.naziv]" x-collapse>
                                <template x-for="(stavka, index) in getStavkeZaKategoriju(kategorija)" :key="kategorija.naziv + '-' + index">
                                    <div
                                        class="tree-item"
                                        :class="{ 'contract-expiring': isContractExpiring(stavka) }"
                                    >
                                        <!-- Inline Edit Mode -->
                                        <template x-if="editingInline && editingInline.stavka === stavka">
                                            <div class="tree-item-name" @click.stop>
                                                <input
                                                    type="text"
                                                    class="inline-edit-input"
                                                    x-model="editingInline.naziv"
                                                    @keydown.enter="saveInlineEdit(kategorija)"
                                                    @keydown.escape="cancelInlineEdit()"
                                                    @blur="saveInlineEdit(kategorija)"
                                                    x-ref="inlineInput"
                                                >
                                            </div>
                                        </template>

                                        <!-- Normal Display Mode -->
                                        <template x-if="!editingInline || editingInline.stavka !== stavka">
                                            <div class="tree-item-name" @dblclick="startInlineEdit(stavka, kategorija)">
                                                <span class="name-text" x-text="stavka.naziv"></span>
                                                <div class="tree-item-icons">
                                                    <template x-if="stavka.napomena">
                                                        <i class="ti ti-info-circle icon-info" :title="stavka.napomena"></i>
                                                    </template>
                                                    <template x-if="stavka.endDate">
                                                        <i class="ti ti-calendar-off icon-end-date" :title="'Zavrsava: ' + formatMonthYear(stavka.endDate)"></i>
                                                    </template>
                                                    <template x-if="stavka.contractEndDate && !isContractExpiring(stavka)">
                                                        <i class="ti ti-file-certificate icon-contract" :title="'Ugovor do: ' + formatMonthYear(stavka.contractEndDate)"></i>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Value - Inline Edit -->
                                        <template x-if="editingInline && editingInline.stavka === stavka">
                                            <input
                                                type="number"
                                                class="inline-edit-input value-input"
                                                x-model.number="editingInline.iznos"
                                                @keydown.enter="saveInlineEdit(kategorija)"
                                                @keydown.escape="cancelInlineEdit()"
                                                @click.stop
                                            >
                                        </template>

                                        <!-- Value - Normal -->
                                        <template x-if="!editingInline || editingInline.stavka !== stavka">
                                            <span class="tree-item-value" @dblclick="startInlineEdit(stavka, kategorija)" x-text="formatCurrency(stavka.iznos)"></span>
                                        </template>

                                        <!-- Actions -->
                                        <div class="tree-item-actions">
                                            <button class="tree-action-btn" @click="openEditItemModal(kategorija, stavka)" title="Uredi">
                                                <i class="ti ti-edit"></i>
                                            </button>
                                            <button class="tree-action-btn danger" @click="deleteStavka(kategorija, stavka)" title="Obrisi">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </div>

                                        <!-- Contract Warning -->
                                        <template x-if="isContractExpiring(stavka)">
                                            <div class="tree-item-warning">
                                                <i class="ti ti-alert-triangle"></i>
                                                <span x-text="getContractWarning(stavka)"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <template x-if="getStavkeZaKategoriju(kategorija).length === 0">
                                    <div class="tree-empty">Nema stavki - klikni + za dodavanje</div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template x-if="kategorije.length === 0">
                        <div class="tree-empty">Nema kategorija - klikni <i class="ti ti-settings"></i> za dodavanje</div>
                    </template>
                </div>
            </div>

            <!-- Right Panel - Summary & Charts -->
            <div class="side-panel">
                <!-- Summary Section -->
                <div class="panel-section">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="ti ti-report-money"></i>
                            <span>Pregled</span>
                        </div>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-row">
                            <span class="summary-label">Ukupni prihodi</span>
                            <span class="summary-value income" x-text="formatCurrency(plata)"></span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Ukupni rashodi</span>
                            <span class="summary-value expense" x-text="formatCurrency(ukupniRashodi)"></span>
                        </div>
                        <div class="summary-row highlight">
                            <span class="summary-label">Ostaje za zivot</span>
                            <span class="summary-value balance" :class="ostajeZaZivot >= 0 ? 'income' : 'expense'" x-text="formatCurrency(ostajeZaZivot)"></span>
                        </div>
                    </div>

                    <!-- Sparkline -->
                    <div class="sparkline-container" x-show="kategorije.length > 0">
                        <template x-for="kategorija in kategorije" :key="'spark-' + kategorija.emoji">
                            <div
                                class="sparkline-bar"
                                :style="'height: ' + getSparklineHeight(kategorija) + '%'"
                                :title="kategorija.emoji + ' ' + kategorija.naziv + ': ' + formatCurrency(getCategoryTotal(kategorija))"
                            ></div>
                        </template>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="panel-section">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="ti ti-chart-pie"></i>
                            <span>Raspodela</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <!-- Expiring Expenses -->
                <div class="panel-section" x-show="expiringExpenses.length > 0">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="ti ti-calendar-off"></i>
                            <span>Oslobadjanje</span>
                        </div>
                    </div>
                    <div class="expiring-list">
                        <template x-for="(monthData, monthKey) in expiringByMonth" :key="monthKey">
                            <div class="expiring-month">
                                <div class="expiring-month-header">
                                    <span class="expiring-month-name" x-text="formatMonthYear(monthKey)"></span>
                                    <span class="expiring-month-total">+<span x-text="formatCurrency(monthData.total)"></span></span>
                                </div>
                                <template x-for="item in monthData.items" :key="item.naziv + item.iznos">
                                    <div class="expiring-item">
                                        <span x-text="item.naziv"></span>
                                        <span x-text="formatCurrency(item.iznos)"></span>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- History Section -->
                <div class="panel-section">
                    <button class="history-toggle" @click="showHistory = !showHistory">
                        <span><i class="ti ti-history"></i> Istorija (<span x-text="istorija.length"></span>)</span>
                        <i class="ti" :class="showHistory ? 'ti-chevron-up' : 'ti-chevron-down'"></i>
                    </button>
                    <div class="history-list" x-show="showHistory">
                        <template x-if="istorija.length === 0">
                            <div class="history-item text-muted">Nema istorije</div>
                        </template>
                        <template x-for="(log, idx) in istorija.slice().reverse()" :key="idx">
                            <div class="history-item" x-text="log"></div>
                        </template>
                    </div>
                </div>
            </div>
        </main>

        <!-- Add/Edit Item Modal -->
        <template x-if="showItemModal">
            <div x-cloak>
                <div class="modal-backdrop" @click="closeItemModal()"></div>
                <div class="modal-container">
                    <div class="modal-content">
                        <div class="modal-header">
                            <span class="modal-title" x-text="editingItem ? 'Uredi stavku' : 'Dodaj stavku'"></span>
                            <button class="modal-close" @click="closeItemModal()">
                                <i class="ti ti-x"></i>
                            </button>
                        </div>
                        <form @submit.prevent="saveItem()">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Naziv</label>
                                    <input type="text" class="form-input" x-model="itemForm.naziv" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Iznos (RSD)</label>
                                    <input type="number" class="form-input" x-model.number="itemForm.iznos" required min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Napomena</label>
                                    <input type="text" class="form-input" x-model="itemForm.napomena" placeholder="Opciono">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Datum zavrsetka</label>
                                    <input type="month" class="form-input" x-model="itemForm.endDate">
                                    <div class="form-hint">Kada prestaje ovaj trosak (npr. rata kredita)</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Kraj ugovora</label>
                                    <input type="month" class="form-input" x-model="itemForm.contractEndDate">
                                    <div class="form-hint">Kada istice ugovor - upozorenje 1 mesec ranije</div>
                                </div>
                                <div class="form-group" x-show="editingItem">
                                    <label class="form-label">Kategorija</label>
                                    <select class="form-input form-select" x-model="itemForm.kategorijaKey">
                                        <template x-for="kat in kategorije" :key="kat.emoji + kat.naziv">
                                            <option :value="kat.emoji + ' ' + kat.naziv" x-text="kat.emoji + ' ' + kat.naziv"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary flex-1" @click="closeItemModal()">Otkazi</button>
                                <button type="submit" class="btn btn-primary flex-1">Sacuvaj</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </template>

        <!-- Category Management Modal -->
        <template x-if="showCategoryModal">
            <div x-cloak>
                <div class="modal-backdrop" @click="closeCategoryModal()"></div>
                <div class="modal-container">
                    <div class="modal-content">
                        <div class="modal-header">
                            <span class="modal-title">Upravljanje kategorijama</span>
                            <button class="modal-close" @click="closeCategoryModal()">
                                <i class="ti ti-x"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Add new category -->
                            <form @submit.prevent="addCategory()" class="category-form">
                                <input
                                    type="text"
                                    class="form-input category-emoji-input"
                                    x-model="newCategory.emoji"
                                    placeholder="E"
                                    maxlength="2"
                                >
                                <input
                                    type="text"
                                    class="form-input flex-1"
                                    x-model="newCategory.naziv"
                                    placeholder="Naziv kategorije"
                                >
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="ti ti-plus"></i>
                                </button>
                            </form>

                            <!-- Existing categories -->
                            <div class="category-list">
                                <template x-for="(kat, index) in kategorije" :key="index">
                                    <div class="category-list-item">
                                        <span class="category-list-item-emoji" x-text="kat.emoji"></span>
                                        <span class="category-list-item-name" x-text="kat.naziv"></span>
                                        <button class="tree-action-btn" @click="editCategory(kat)">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button class="tree-action-btn danger" @click="deleteCategory(kat)">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary btn-block" @click="closeCategoryModal()">Zatvori</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

    </div>

    <!-- Chart JS -->
    <script src="js/chart.js"></script>
    <!-- App JS -->
    <script src="js/app.js"></script>
</body>
</html>
